<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkLawn Client Management</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjlKrXPJ2EUaMtIigsc65MFj7-lFNv26A&libraries=places&callback=initAutocomplete"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Navigation Menu */
        .nav-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #1a1f2e 0%, #2a3441 100%);
            border-bottom: 2px solid #10b981;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .nav-brand {
            margin-right: 40px;
            display: flex;
            align-items: center;
        }

        .nav-brand img {
            height: 32px;
            width: auto;
        }

        .nav-links {
            display: flex;
            gap: 8px;
            flex: 1;
        }

        .nav-link {
            padding: 8px 16px;
            color: #e2e8f0;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .nav-link.active {
            background: #10b981;
            color: #0a0e1a;
        }

        .nav-user {
            margin-left: auto;
            color: #94a3b8;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sign-out-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: 1px solid #059669;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sign-out-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-color: #047857;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }

        /* Hamburger menu (hidden on desktop) */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            padding: 8px;
            margin-left: auto;
        }

        .hamburger span {
            width: 24px;
            height: 3px;
            background: #10b981;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }

            .nav-links {
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                background: #1a1f2e;
                flex-direction: column;
                padding: 20px;
                gap: 12px;
                transform: translateY(-100%);
                opacity: 0;
                pointer-events: none;
                transition: all 0.3s ease;
                border-bottom: 2px solid #10b981;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .nav-links.active {
                transform: translateY(0);
                opacity: 1;
                pointer-events: all;
            }

            .nav-link {
                width: 100%;
                text-align: center;
                padding: 12px;
                font-size: 16px;
            }

            .nav-user {
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                background: #1a1f2e;
                padding: 16px 20px;
                justify-content: space-between;
                border-top: 1px solid #334155;
                transform: translateY(-100%);
                opacity: 0;
                pointer-events: none;
                transition: all 0.3s ease;
                margin-top: 216px;
            }

            .nav-links.active ~ .nav-user {
                transform: translateY(0);
                opacity: 1;
                pointer-events: all;
            }

            .nav-brand {
                margin-right: 0;
            }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #0f1419 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
            padding-top: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #1a1f2e;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #2a3441;
        }

        .header h1 {
            color: #10b981;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: #94a3b8;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #1a1f2e;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #2a3441;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section {
            background: #1a1f2e;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
            border: 1px solid #2a3441;
        }

        .section h2 {
            color: #e2e8f0;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        input, select {
            background: #0f1419;
            border: 1px solid #2a3441;
            border-radius: 6px;
            padding: 8px 10px;
            color: #e2e8f0;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #10b981;
        }

        .btn {
            background: #10b981;
            color: #0f1419;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #374151;
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .clients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .clients-table th,
        .clients-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #2a3441;
        }

        .clients-table th {
            color: #94a3b8;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #0f1419;
        }

        .clients-table td {
            color: #e2e8f0;
            font-size: 14px;
        }

        .clients-table tr:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status.active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .error {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid #dc2626;
            color: #fca5a5;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .success {
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 400;
        }

        /* Google Places Autocomplete styling */
        .pac-container {
            background: #1a1f2e !important;
            border: 1px solid #2a3441 !important;
            border-radius: 6px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }

        .pac-item {
            background: #1a1f2e !important;
            color: #e2e8f0 !important;
            border-top: 1px solid #2a3441 !important;
            padding: 8px 12px !important;
            cursor: pointer !important;
        }

        .pac-item:hover {
            background: rgba(16, 185, 129, 0.1) !important;
        }

        .pac-item-selected {
            background: rgba(16, 185, 129, 0.2) !important;
        }

        .pac-item-query {
            color: #10b981 !important;
        }

        .pac-matched {
            color: #e2e8f0 !important;
            font-weight: 600 !important;
        }

        /* Search input styles */
        #clientSearch:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        #clientSearch:focus::placeholder {
            color: #6b7280;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            #clientSearch {
                font-size: 16px; /* Prevent zoom on iOS */
            }

            /* Compact form mobile layout */
            #addClientForm > div:first-child {
                grid-template-columns: 1fr !important;
            }

            #addClientForm > div:nth-child(2) {
                grid-template-columns: auto auto !important;
                gap: 12px !important;
            }

            #addClientForm > div:nth-child(2) select {
                grid-column: 1 / -1 !important;
            }

            #addClientForm > div:nth-child(2) input[readonly] {
                grid-column: 1 / -1 !important;
                width: 100% !important;
            }
        }

    </style>
</head>
<body>
    <!-- Navigation Menu -->
    <nav class="nav-menu">
        <div class="nav-brand">
            <img src="https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=768,fit=crop,q=95/AMqajOBKjaiq4bNK/sparklawn-logo_white-ALpbzbLkvNc5b3nv.png" alt="SparkLawn">
        </div>
        <div class="nav-links" id="navLinks">
            <a href="/fleet-advanced" class="nav-link">Fleet Dashboard</a>
            <a href="/client-management" class="nav-link active">Client Locations</a>
            <a href="/trip-modal-preview" class="nav-link">Today's Trip Detail</a>
            <a href="/daily-report-preview" class="nav-link">Daily Report</a>
        </div>
        <div class="nav-user" id="navUser">
            <span id="nav-user-email"></span>
            <a href="/auth/logout" class="sign-out-btn">
                <span>🚪</span>
                <span>Sign Out</span>
            </a>
        </div>
        <div class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>🏢 Client Location Management</h1>
        </div>


        <div class="section" style="padding: 12px 18px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h2 id="formTitle" style="margin: 0; font-size: 16px;">➕ Add New Location</h2>
                <div style="display: flex; gap: 8px;">
                    <button type="button" class="btn btn-secondary" onclick="clearForm()" style="padding: 6px 12px; font-size: 13px;">Clear</button>
                    <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display: none; padding: 6px 12px; font-size: 13px;" onclick="cancelEdit()">Cancel</button>
                </div>
            </div>
            <div id="addClientMessage"></div>
            <form id="addClientForm">
                <!-- Row 1: Name, Address Search, Radius -->
                <div style="display: grid; grid-template-columns: 1fr 2fr 140px; gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="locationName" name="locationName" required placeholder="Location Name *" autocomplete="off" style="padding: 8px 10px; font-size: 13px;">
                    <input type="text" id="address" name="address" placeholder="🔍 Search address to zoom map..." autocomplete="off" style="padding: 8px 10px; font-size: 13px;">
                    <div>
                        <label for="radius" style="display: block; color: #94a3b8; font-size: 11px; margin-bottom: 3px;">Radius (ft)</label>
                        <input type="number" id="radius" name="radius" placeholder="330" min="150" max="1600" style="padding: 8px 10px; font-size: 13px; width: 100%;" value="330">
                    </div>
                </div>

                <!-- Row 2: Checkboxes, Property Type, Coordinates -->
                <div style="display: grid; grid-template-columns: auto auto 1fr 120px 120px; gap: 8px; align-items: center; margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: #94a3b8; white-space: nowrap; margin: 0;">
                        <input type="checkbox" id="isClient" name="isClient" checked style="margin: 0;">
                        Client
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: #94a3b8; white-space: nowrap; margin: 0;">
                        <input type="checkbox" id="isActive" name="isActive" checked style="margin: 0;">
                        Active
                    </label>
                    <select id="clientType" name="clientType" style="padding: 8px 10px; border: 1px solid #374151; border-radius: 6px; background: #1f2937; color: #e5e7eb; font-size: 13px;">
                        <option value="residential">🏠 Residential</option>
                        <option value="commercial">🏢 Commercial</option>
                        <option value="other">🏪 Other</option>
                    </select>
                    <input type="number" id="latitude" name="latitude" step="any" placeholder="Lat (click map)" required readonly style="background: #0a0e1a; cursor: not-allowed; padding: 8px 10px; font-size: 12px;">
                    <input type="number" id="longitude" name="longitude" step="any" placeholder="Lng (click map)" required readonly style="background: #0a0e1a; cursor: not-allowed; padding: 8px 10px; font-size: 12px;">
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn" id="submitBtn" style="width: 100%; padding: 10px; font-size: 14px;">Add Location</button>
            </form>
        </div>

        <div class="section">
            <h2>🗺️ Interactive Map</h2>
            <p style="color: #94a3b8; margin-bottom: 16px;">🔍 Type an address above to zoom → 📍 Click map to drop pin at exact location</p>
            <div id="map" style="width: 100%; height: 400px; border-radius: 8px; margin-bottom: 24px;"></div>
        </div>

        <div class="section">
            <h2>📋 Location Directory</h2>
            <div id="clientsLoading" class="loading">Loading clients...</div>
            <div id="clientsContainer" style="display: none;">
                <!-- Map Actions -->
                <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                    <button
                        onclick="showAllClientsOnMap()"
                        class="btn btn-secondary"
                        style="padding: 8px 16px; font-size: 12px;"
                        title="Show all client locations as pins on the map"
                    >
                        🗺️ Show All on Map
                    </button>
                    <button
                        onclick="showActiveClientsOnMap()"
                        class="btn btn-primary"
                        style="padding: 8px 16px; font-size: 12px; margin-left: 8px;"
                        title="Show only active clients on the map"
                    >
                        ✅ Show Active Clients
                    </button>
                    <button
                        onclick="showResidentialOnly()"
                        class="btn btn-secondary"
                        style="padding: 8px 16px; font-size: 12px; margin-left: 8px;"
                        title="Show only residential properties"
                    >
                        🏠 Residential Only
                    </button>
                    <button
                        onclick="showCommercialOnly()"
                        class="btn btn-secondary"
                        style="padding: 8px 16px; font-size: 12px; margin-left: 8px;"
                        title="Show only commercial properties"
                    >
                        🏢 Commercial Only
                    </button>
                    <span id="countsLegend" style="color: #6b7280; font-size: 12px;">| 📍 Red: Residential • 🟢 Green: Commercial • 🟡 Yellow: Other</span>
                </div>

                <!-- Search Bar -->
                <div style="margin-bottom: 16px;">
                    <div style="position: relative; max-width: 400px;">
                        <input
                            type="text"
                            id="clientSearch"
                            placeholder="🔍 Search clients by name or address..."
                            style="width: 100%; padding: 12px 16px 12px 40px; border: 1px solid #374151; border-radius: 8px; background: #1f2937; color: #e5e7eb; font-size: 14px; transition: all 0.2s;"
                            onkeyup="filterClients()"
                        >
                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 16px;">🔍</span>
                        <button
                            id="clearSearchBtn"
                            onclick="clearSearch()"
                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; padding: 4px; display: none;"
                            title="Clear search"
                        >✕</button>
                    </div>
                    <div id="searchStats" style="margin-top: 8px; color: #9ca3af; font-size: 12px;"></div>
                </div>
                <table class="clients-table">
                    <thead>
                        <tr>
                            <th>Location Name</th>
                            <th>Address</th>
                            <th>Coordinates</th>
                            <th>Radius</th>
                            <th>Last Updated</th>
                            <th>Type</th>
                            <th>Property</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                        <!-- Client rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const navLinks = document.getElementById('navLinks');
            const hamburger = document.getElementById('hamburger');
            navLinks.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        // Utility function to properly capitalize addresses
        function formatAddress(address) {
            if (!address || typeof address !== 'string') return address;

            // List of words that should remain lowercase (except at start)
            const lowerCaseWords = ['and', 'or', 'the', 'a', 'an', 'in', 'on', 'at', 'by', 'for', 'of', 'to', 'up', 'as', 'but', 'is', 'are', 'was', 'were'];

            // List of common abbreviations that should be uppercase
            const upperCaseWords = ['st', 'ave', 'dr', 'rd', 'blvd', 'ln', 'ct', 'pl', 'way', 'pkwy', 'hwy', 'apt', 'suite', 'ste', 'unit', 'bldg', 'fl', 'po', 'box', 'ar', 'arkansas', 'usa', 'us'];

            return address.toLowerCase().split(' ').map((word, index) => {
                // Remove punctuation for comparison but keep it in the word
                const cleanWord = word.replace(/[^\w]/g, '');

                // Always capitalize first word
                if (index === 0) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }

                // Handle special uppercase words
                if (upperCaseWords.includes(cleanWord.toLowerCase())) {
                    return word.replace(cleanWord, cleanWord.toUpperCase());
                }

                // Keep small words lowercase unless they start a sentence
                if (lowerCaseWords.includes(cleanWord.toLowerCase())) {
                    return word;
                }

                // Handle numbers followed by letters (like 38th, 1st, 2nd, 3rd)
                if (/^\d+(st|nd|rd|th)$/i.test(cleanWord)) {
                    return word.toLowerCase();
                }

                // Capitalize first letter of other words
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }

        // API functions
        async function loadClients() {
            try {
                const response = await fetch('/api/clients');
                const data = await response.json();

                if (response.ok) {

                    // Store original clients for search functionality
                    originalClients = data.clients;
                    filteredClients = [...originalClients];

                    renderClientsTable(filteredClients);
                    showClientsTable();
                    updateCounts(); // Initialize counts on page load

                    // Auto-load active clients on the map
                    setTimeout(() => {
                        showActiveClientsOnMap();
                    }, 500); // Small delay to ensure map is ready
                } else {
                    showError('Failed to load clients: ' + data.error);
                }
            } catch (error) {
                showError('Error loading clients: ' + error.message);
            }
        }

        async function addLocation(formData) {
            try {
                const url = isEditMode ? `/api/clients/${encodeURIComponent(editingAddress)}` : '/api/clients';
                const method = isEditMode ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    const type = formData.isClient ? 'client' : 'marker';
                    const action = isEditMode ? 'updated' : 'added';
                    const message = isEditMode
                        ? `${formData.isClient ? 'Client' : 'Marker'} "${formData.clientName}" updated successfully!`
                        : `${formData.isClient ? 'Client' : 'Marker'} "${formData.clientName}" added successfully! Total locations: ${data.totalClients}`;

                    showSuccess(message);
                    clearForm();
                    loadClients(); // Refresh the list
                } else {
                    showError(`Failed to ${isEditMode ? 'update' : 'add'} ${formData.isClient ? 'client' : 'marker'}: ` + data.error);
                }
            } catch (error) {
                showError(`Error ${isEditMode ? 'updating' : 'adding'} ${formData.isClient ? 'client' : 'marker'}: ` + error.message);
            }
        }

        async function deleteLocation(address, locationName) {
            if (!confirm(`Are you sure you want to delete "${locationName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/clients/${encodeURIComponent(address)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess(`Location "${locationName}" deleted successfully!`);
                    loadClients(); // Refresh the list
                } else {
                    showError('Failed to delete location: ' + data.error);
                }
            } catch (error) {
                showError('Error deleting location: ' + error.message);
            }
        }

        // UI functions

        function renderClientsTable(clients) {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';

            // Store clients for duplicate checking
            allClients = clients;

            clients.forEach(client => {
                const isClient = client.isClient !== false; // Default to true for backwards compatibility
                const typeLabel = isClient ? '<span class="status active">Client</span>' : '<span style="color: #94a3b8;">Marker</span>';

                // Escape quotes and special characters for onclick handlers
                const escapedAddress = client.address.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const escapedClientName = client.clientName.replace(/'/g, "\\'").replace(/"/g, '\\"');

                const row = document.createElement('tr');
                // Create property type label
                let propertyIcon, propertyLabel;
                if (client.clientType === 'commercial') {
                    propertyIcon = '🏢';
                    propertyLabel = 'Commercial';
                } else if (client.clientType === 'other') {
                    propertyIcon = '🏪';
                    propertyLabel = 'Other';
                } else { // residential or default
                    propertyIcon = '🏠';
                    propertyLabel = 'Residential';
                }

                row.innerHTML = `
                    <td><strong><a href="#" onclick="previewLocation(${client.lat}, ${client.lng}, '${escapedClientName}'); return false;" style="color: #10b981; text-decoration: none; cursor: pointer;">${client.clientName}</a></strong></td>
                    <td>${formatAddress(client.address)}</td>
                    <td>${client.lat && client.lng ? `${client.lat.toFixed(6)}, ${client.lng.toFixed(6)}` : 'Not geocoded'}</td>
                    <td>${Math.round(client.radius * 3.28084)}ft</td>
                    <td>${new Date(client.lastUpdated).toLocaleDateString()}</td>
                    <td>${typeLabel}</td>
                    <td><span style="color: #94a3b8; font-size: 12px;">${propertyIcon} ${propertyLabel}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="editLocation('${escapedAddress}', '${escapedClientName}', ${client.lat}, ${client.lng}, ${client.radius}, ${isClient}, '${client.clientType || 'residential'}', ${client.isActive !== false})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteLocation('${escapedAddress}', '${escapedClientName}')">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showClientsTable() {
            document.getElementById('clientsLoading').style.display = 'none';
            document.getElementById('clientsContainer').style.display = 'block';
        }

        // Search functionality
        let originalClients = []; // Store original unfiltered clients
        let filteredClients = []; // Store current filtered results

        function filterClients() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase().trim();
            const clearBtn = document.getElementById('clearSearchBtn');
            const searchStats = document.getElementById('searchStats');

            // Show/hide clear button based on search input
            clearBtn.style.display = searchTerm ? 'block' : 'none';

            if (!searchTerm) {
                // No search term - show all clients
                filteredClients = [...originalClients];
                searchStats.textContent = '';
            } else {
                // Filter clients based on search term
                filteredClients = originalClients.filter(client => {
                    return client.clientName.toLowerCase().includes(searchTerm) ||
                           client.address.toLowerCase().includes(searchTerm);
                });

                // Update search stats
                const total = originalClients.length;
                const found = filteredClients.length;
                searchStats.textContent = `Showing ${found} of ${total} locations`;
            }

            // Re-render table with filtered results
            renderClientsTable(filteredClients);
        }

        function clearSearch() {
            document.getElementById('clientSearch').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            document.getElementById('searchStats').textContent = '';

            // Reset to show all clients
            filteredClients = [...originalClients];
            renderClientsTable(filteredClients);
        }

        function showError(message) {
            const container = document.getElementById('addClientMessage');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        function showSuccess(message) {
            const container = document.getElementById('addClientMessage');
            container.innerHTML = `<div class="success">${message}</div>`;
        }

        function clearForm() {
            document.getElementById('addClientForm').reset();
            document.getElementById('addClientMessage').innerHTML = '';

            // Reset edit mode
            isEditMode = false;
            editingAddress = null;
            document.getElementById('formTitle').textContent = '➕ Add New Location';
            document.getElementById('submitBtn').textContent = 'Add Location';
            document.getElementById('cancelEditBtn').style.display = 'none';

            // Clear readonly coordinates
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';

            // Clear map marker
            if (marker) {
                marker.setMap(null);
                marker = null;
            }

            // Reset map view
            if (map) {
                map.setCenter({ lat: 36.183115, lng: -94.169488 });
                map.setZoom(12);
            }
        }

        function editLocation(address, locationName, lat, lng, radius, isClient = true, clientType = 'residential', isActive = true) {
            // Switch to edit mode
            isEditMode = true;
            editingAddress = address;

            // Update form title and button
            document.getElementById('formTitle').textContent = '✏️ Edit Location';
            document.getElementById('submitBtn').textContent = 'Update Location';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // Populate form fields
            document.getElementById('locationName').value = locationName;
            document.getElementById('address').value = address;
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            document.getElementById('radius').value = Math.round(radius * 3.28084); // Convert meters to feet for display
            document.getElementById('isClient').checked = isClient;
            document.getElementById('clientType').value = clientType;
            document.getElementById('isActive').checked = isActive;

            // Update map and marker (zoom to existing client location)
            const location = { lat, lng };
            map.setCenter(location);
            map.setZoom(20); // Parcel-level zoom for editing
            map.setMapTypeId(google.maps.MapTypeId.SATELLITE); // Switch to satellite view

            if (marker) {
                marker.setPosition(location);
            } else {
                marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: locationName,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#10b981"/>
                                <circle cx="12" cy="9" r="2.5" fill="white"/>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(32, 32),
                        anchor: new google.maps.Point(16, 32)
                    }
                });
            }

            // Clear any messages
            document.getElementById('addClientMessage').innerHTML = '';

            // Scroll to form
            document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });

            console.log(`📝 Editing location: ${locationName} at ${lat}, ${lng}`);
        }

        function cancelEdit() {
            clearForm();
        }

        function previewLocation(lat, lng, locationName) {
            // Zoom to the location on the map for preview
            const location = { lat, lng };
            map.setCenter(location);
            map.setZoom(20); // Parcel-level zoom for preview
            map.setMapTypeId(google.maps.MapTypeId.SATELLITE); // Switch to satellite view

            // Show preview marker (different color from edit marker)
            if (marker) {
                marker.setMap(null); // Clear any existing marker
            }

            marker = new google.maps.Marker({
                position: location,
                map: map,
                title: `Preview: ${locationName}`,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#3b82f6"/>
                            <circle cx="12" cy="9" r="2.5" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(32, 32),
                    anchor: new google.maps.Point(16, 32)
                }
            });

            console.log(`🔍 Previewing location: ${locationName} at ${lat}, ${lng}`);

            // Show temporary preview message
            const tempMessage = document.getElementById('addClientMessage');
            if (tempMessage) {
                tempMessage.innerHTML = `<div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; color: #93c5fd; padding: 12px; border-radius: 6px;">📍 Previewing: ${locationName}</div>`;

                // Clear message after 3 seconds
                setTimeout(() => {
                    tempMessage.innerHTML = '';
                }, 3000);
            }
        }

        function showDuplicateAddressPopup(existingClient) {
            const radiusInFeet = Math.round(existingClient.radius * 3.28084);
            const clientType = existingClient.isClient !== false ? 'Client' : 'Marker';

            const popup = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="duplicatePopup">
                    <div style="background: #1a1f2e; border: 1px solid #2a3441; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
                        <h3 style="color: #e2e8f0; margin: 0 0 16px 0; font-size: 18px;">⚠️ Duplicate Address Detected</h3>

                        <div style="background: #0f1419; border: 1px solid #2a3441; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <div style="color: #10b981; font-weight: 600; margin-bottom: 8px;">${existingClient.clientName}</div>
                            <div style="color: #94a3b8; font-size: 14px; margin-bottom: 4px;">📍 ${existingClient.address}</div>
                            <div style="color: #94a3b8; font-size: 14px; margin-bottom: 4px;">📊 Detection Radius: ${radiusInFeet}ft</div>
                            <div style="color: #94a3b8; font-size: 14px; margin-bottom: 4px;">🏷️ Type: ${clientType}</div>
                            <div style="color: #64748b; font-size: 12px;">Last Updated: ${new Date(existingClient.lastUpdated).toLocaleDateString()}</div>
                        </div>

                        <p style="color: #94a3b8; margin: 0 0 20px 0; font-size: 14px;">
                            This address already exists in your system. What would you like to do?
                        </p>

                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button onclick="editExistingLocation('${existingClient.address}', '${existingClient.clientName}', ${existingClient.lat}, ${existingClient.lng}, ${existingClient.radius}, ${existingClient.isClient !== false}, '${existingClient.clientType || 'residential'}', ${existingClient.isActive !== false})"
                                    style="background: #10b981; color: #0f1419; border: none; border-radius: 6px; padding: 10px 16px; font-size: 14px; font-weight: 600; cursor: pointer; flex: 1;">
                                ✏️ Edit Existing
                            </button>
                            <button onclick="deleteExistingLocation('${existingClient.address}', '${existingClient.clientName}')"
                                    style="background: #dc2626; color: white; border: none; border-radius: 6px; padding: 10px 16px; font-size: 14px; font-weight: 600; cursor: pointer; flex: 1;">
                                🗑️ Delete Existing
                            </button>
                            <button onclick="closeDuplicatePopup()"
                                    style="background: #374151; color: #e2e8f0; border: none; border-radius: 6px; padding: 10px 16px; font-size: 14px; font-weight: 600; cursor: pointer; flex: 1;">
                                ❌ Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', popup);
        }

        function editExistingLocation(address, locationName, lat, lng, radius, isClient, clientType = 'residential', isActive = true) {
            closeDuplicatePopup();
            editLocation(address, locationName, lat, lng, radius, isClient, clientType, isActive);
        }

        function deleteExistingLocation(address, locationName) {
            closeDuplicatePopup();
            deleteLocation(address, locationName);
        }

        function closeDuplicatePopup() {
            const popup = document.getElementById('duplicatePopup');
            if (popup) {
                popup.remove();
            }
            // Clear the address input to prevent re-triggering
            document.getElementById('address').value = '';
        }

        // Map pins functionality
        let clientPins = []; // Store all client pins

        async function setAllResidential() {
            if (!confirm('This will set ALL client locations to Residential type. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/clients/set-all-residential', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess(`✅ ${data.message}`);
                    loadClients(); // Refresh the list
                } else {
                    showError('Failed to update client types: ' + data.error);
                }
            } catch (error) {
                showError('Error updating client types: ' + error.message);
            }
        }


        function showAllClientsOnMap() {
            if (!originalClients || originalClients.length === 0) {
                showError('No client data available. Please wait for clients to load.');
                return;
            }

            // Clear existing client pins
            clearClientPins();

            // Show all clients using the new pin logic
            addPinsToMap(originalClients);
            updateCounts();
            updateActiveFilter('all');
        }

        function showActiveClientsOnMap() {
            if (!originalClients || originalClients.length === 0) {
                showError('No client data available. Please wait for clients to load.');
                return;
            }

            // Clear existing client pins
            clearClientPins();

            // Filter to active clients only
            const activeClients = originalClients.filter(client => client.isActive !== false);

            if (activeClients.length === 0) {
                showError('No active clients found. All clients may be inactive.');
                return;
            }

            // Add pins for active clients only
            let bounds = new google.maps.LatLngBounds();
            let pinCount = 0;

            activeClients.forEach(client => {
                if (client.lat && client.lng) {
                    const position = { lat: client.lat, lng: client.lng };

                    // Check for special McRay Shop lightning bolt pin
                    const isSpecialLocation = client.clientName.toLowerCase().includes('mcray');

                    let pinColor, glowColor, pinIcon;

                    if (isSpecialLocation) {
                        // Special lightning bolt pin with green background for McRay Shop
                        pinColor = '#22c55e';  // Green
                        glowColor = '#16a34a'; // Darker green
                        pinIcon = '⚡';
                    } else {
                        // Regular pins by type - actual pin shapes with colored tops
                        if (client.clientType === 'commercial') {
                            pinColor = '#22c55e'; // Green top
                        } else if (client.clientType === 'other') {
                            pinColor = '#eab308'; // Yellow top (changed from blue)
                        } else { // residential or default
                            pinColor = '#ef4444'; // Red top
                        }
                    }

                    const pin = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: client.clientName,
                        icon: isSpecialLocation ? {
                            // Special lightning bolt for McRay Shop - 2/3 smaller size
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <!-- Circular background -->
                                    <circle cx="10.5" cy="10.5" r="10" fill="#22c55e" stroke="#ffffff" stroke-width="1.5"/>
                                    <!-- Lightning bolt emoji -->
                                    <text x="10.5" y="15" text-anchor="middle" font-size="12" fill="white">⚡</text>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(21, 21),
                            anchor: new google.maps.Point(10.5, 10.5)
                        } : {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="24" height="32" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                        <radialGradient id="pinGrad" cx="0.3" cy="0.3" r="0.8">
                                            <stop offset="0%" style="stop-color:${pinColor};stop-opacity:1" />
                                            <stop offset="70%" style="stop-color:${pinColor};stop-opacity:0.8" />
                                            <stop offset="100%" style="stop-color:${pinColor};stop-opacity:0.6" />
                                        </radialGradient>
                                    </defs>
                                    <!-- Pin head (circle) - 50% smaller -->
                                    <circle cx="12" cy="12" r="5" fill="url(#pinGrad)" stroke="#ffffff" stroke-width="0.5"/>
                                    <!-- Pin stem (gray) -->
                                    <rect x="11" y="20" width="2" height="10" fill="#6b7280"/>
                                    <!-- Highlight on pin head -->
                                    <ellipse cx="10" cy="10" rx="1.5" ry="1" fill="#ffffff" opacity="0.4"/>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(24, 32),
                            anchor: new google.maps.Point(12, 30)
                        }
                    });

                    // Add click event for info window
                    pin.addListener('click', () => {
                        const radiusFeet = Math.round(client.radius * 3.28084);
                        const statusLabel = isSpecialLocation ? 'McRay Shop ⚡' :
                                           (client.clientType === 'commercial' ? 'Commercial' :
                                            client.clientType === 'other' ? 'Other' : 'Residential');

                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div style="color: #333; font-family: system-ui;">
                                    <strong>${client.clientName}</strong><br>
                                    <small>${formatAddress(client.address)}</small><br>
                                    <span style="color: #666;">${isSpecialLocation ? '⚡' : pinIcon} ${statusLabel} • ${radiusFeet}ft radius</span><br>
                                    <button onclick="editLocation('${client.address.replace(/'/g, "\\'")}', '${client.clientName.replace(/'/g, "\\'")}', ${client.lat}, ${client.lng}, ${client.radius}, ${client.isClient !== false}, '${client.clientType || 'residential'}', ${client.isActive !== false})" style="margin-top: 8px; padding: 4px 8px; font-size: 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">Edit Location</button>
                                </div>
                            `
                        });
                        infoWindow.open(map, pin);
                    });

                    clientPins.push(pin);
                    bounds.extend(position);
                    pinCount++;
                }
            });

            if (pinCount > 0) {
                // Fit map to show all active pins
                map.fitBounds(bounds);

                // Ensure minimum zoom level
                google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
                    if (map.getZoom() > 15) {
                        map.setZoom(15);
                    }
                });

                updateCounts();
                updateActiveFilter('active');
            } else {
                showError('No active client locations with coordinates found.');
            }
        }

        function clearClientPins() {
            clientPins.forEach(pin => pin.setMap(null));
            clientPins = [];
        }

        function showResidentialOnly() {
            if (!originalClients || originalClients.length === 0) {
                showError('No client data available. Please wait for clients to load.');
                return;
            }

            // Clear existing client pins
            clearClientPins();

            // Filter to active residential clients only
            const residentialClients = originalClients.filter(client =>
                client.isActive !== false &&
                (client.clientType === 'residential' || !client.clientType)
            );

            if (residentialClients.length === 0) {
                showError('No active residential clients found.');
                return;
            }

            addPinsToMap(residentialClients);
            updateCounts();
            updateActiveFilter('residential');
        }

        function showCommercialOnly() {
            if (!originalClients || originalClients.length === 0) {
                showError('No client data available. Please wait for clients to load.');
                return;
            }

            // Clear existing client pins
            clearClientPins();

            // Filter to active commercial clients only
            const commercialClients = originalClients.filter(client =>
                client.isActive !== false &&
                client.clientType === 'commercial'
            );

            if (commercialClients.length === 0) {
                showError('No active commercial clients found.');
                return;
            }

            addPinsToMap(commercialClients);
            updateCounts();
            updateActiveFilter('commercial');
        }

        function addPinsToMap(clients) {
            let bounds = new google.maps.LatLngBounds();
            let pinCount = 0;

            clients.forEach(client => {
                if (client.lat && client.lng) {
                    const position = { lat: client.lat, lng: client.lng };

                    // Check for special McRay Shop lightning bolt pin
                    const isSpecialLocation = client.clientName.toLowerCase().includes('mcray');
                    let pinColor;

                    if (isSpecialLocation) {
                        pinColor = '#22c55e';  // Green
                    } else {
                        // Regular pins by type - actual pin shapes with colored tops
                        if (client.clientType === 'commercial') {
                            pinColor = '#22c55e'; // Green top
                        } else if (client.clientType === 'other') {
                            pinColor = '#eab308'; // Yellow top
                        } else { // residential or default
                            pinColor = '#ef4444'; // Red top
                        }
                    }

                    const pin = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: client.clientName,
                        icon: isSpecialLocation ? {
                            // Special lightning bolt for McRay Shop
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="10.5" cy="10.5" r="10" fill="#22c55e" stroke="#ffffff" stroke-width="1.5"/>
                                    <text x="10.5" y="15" text-anchor="middle" font-size="12" fill="white">⚡</text>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(21, 21),
                            anchor: new google.maps.Point(10.5, 10.5)
                        } : {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="24" height="32" viewBox="0 0 24 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                        <radialGradient id="pinGrad2" cx="0.3" cy="0.3" r="0.8">
                                            <stop offset="0%" style="stop-color:${pinColor};stop-opacity:1" />
                                            <stop offset="70%" style="stop-color:${pinColor};stop-opacity:0.8" />
                                            <stop offset="100%" style="stop-color:${pinColor};stop-opacity:0.6" />
                                        </radialGradient>
                                    </defs>
                                    <!-- Pin head (circle) - 50% smaller -->
                                    <circle cx="12" cy="12" r="5" fill="url(#pinGrad2)" stroke="#ffffff" stroke-width="0.5"/>
                                    <!-- Pin stem (gray) -->
                                    <rect x="11" y="20" width="2" height="10" fill="#6b7280"/>
                                    <!-- Highlight on pin head -->
                                    <ellipse cx="10" cy="10" rx="1.5" ry="1" fill="#ffffff" opacity="0.4"/>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(24, 32),
                            anchor: new google.maps.Point(12, 30)
                        }
                    });

                    // Add click event for info window
                    pin.addListener('click', () => {
                        const radiusFeet = Math.round(client.radius * 3.28084);
                        const statusLabel = isSpecialLocation ? 'McRay Shop ⚡' :
                                           (client.clientType === 'commercial' ? 'Commercial' :
                                            client.clientType === 'other' ? 'Other' : 'Residential');
                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div style="color: #1f2937; font-family: Inter, sans-serif;">
                                    <h3 style="margin: 0 0 8px 0; color: #10b981; font-size: 14px; font-weight: 600;">${client.clientName}</h3>
                                    <p style="margin: 4px 0; font-size: 12px; color: #6b7280;">${client.address}</p>
                                    <p style="margin: 4px 0; font-size: 12px;"><strong>Type:</strong> ${statusLabel}</p>
                                    <p style="margin: 4px 0; font-size: 12px;"><strong>Detection Radius:</strong> ${radiusFeet}ft</p>
                                    <p style="margin: 4px 0; font-size: 12px;"><strong>Coordinates:</strong> ${client.lat.toFixed(6)}, ${client.lng.toFixed(6)}</p>
                                </div>
                            `
                        });
                        infoWindow.open(map, pin);
                    });

                    bounds.extend(position);
                    clientPins.push(pin);
                    pinCount++;
                }
            });

            // Adjust map view to show all pins
            if (pinCount > 0) {
                map.fitBounds(bounds);
                if (map.getZoom() > 15) {
                    map.setZoom(15);
                }
            }
        }

        function updateCounts() {
            if (!originalClients) return;

            const residential = originalClients.filter(c => c.clientType === 'residential' || !c.clientType).length;
            const commercial = originalClients.filter(c => c.clientType === 'commercial').length;
            const other = originalClients.filter(c => c.clientType === 'other').length;
            const total = originalClients.length;

            // Update the color legend to show counts with color-coded indicators
            const legend = document.getElementById('countsLegend');
            if (legend) {
                legend.innerHTML = `| <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ef4444; margin-right: 4px;"></span>Residential: ${residential} • <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #10b981; margin-right: 4px;"></span>Commercial: ${commercial} • <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #eab308; margin-right: 4px;"></span>Other: ${other} • Total: ${total}`;
            }
        }

        function updateActiveFilter(activeFilter) {
            // Reset all button styles
            const buttons = document.querySelectorAll('button[onclick*="show"]');
            buttons.forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });

            // Highlight the active button
            let activeButton;
            switch(activeFilter) {
                case 'all':
                    activeButton = document.querySelector('button[onclick="showAllClientsOnMap()"]');
                    break;
                case 'active':
                    activeButton = document.querySelector('button[onclick="showActiveClientsOnMap()"]');
                    break;
                case 'residential':
                    activeButton = document.querySelector('button[onclick="showResidentialOnly()"]');
                    break;
                case 'commercial':
                    activeButton = document.querySelector('button[onclick="showCommercialOnly()"]');
                    break;
            }

            if (activeButton) {
                activeButton.classList.remove('btn-secondary');
                activeButton.classList.add('btn-primary');
            }
        }

        // Event listeners
        document.getElementById('addClientForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validation
            const locationName = document.getElementById('locationName').value.trim();
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;

            if (!locationName) {
                showError('Location name is required!');
                document.getElementById('locationName').focus();
                return;
            }

            if (!lat || !lng) {
                showError('Please click on the map to set coordinates!');
                return;
            }

            const formData = {
                clientName: locationName,
                address: document.getElementById('address').value || `${locationName} (${lat}, ${lng})`,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                radius: document.getElementById('radius').value ? Math.round(parseInt(document.getElementById('radius').value) / 3.28084) : 100, // Convert feet to meters for storage
                isClient: document.getElementById('isClient').checked,
                clientType: document.getElementById('clientType').value,
                isActive: document.getElementById('isActive').checked
            };

            // Check for duplicate addresses before submitting (only if not in edit mode)
            if (!isEditMode && formData.address) {
                const existingClient = allClients.find(client => {
                    // Check if addresses are very similar
                    const normalizedExisting = client.address.toLowerCase().trim();
                    const normalizedNew = formData.address.toLowerCase().trim();

                    // Check for exact match or if one contains the other
                    return normalizedExisting === normalizedNew ||
                           normalizedExisting.includes(normalizedNew) ||
                           normalizedNew.includes(normalizedExisting);
                });

                if (existingClient) {
                    showDuplicateAddressPopup(existingClient);
                    return; // Stop form submission
                }
            }

            await addLocation(formData);
        });

        // Global variables
        let autocomplete;
        let map;
        let marker;
        let isEditMode = false;
        let editingAddress = null;
        let allClients = []; // Store all clients for duplicate checking

        function initAutocomplete() {
            // Initialize the map centered on NW Arkansas
            const mapCenter = { lat: 36.183115, lng: -94.169488 }; // McRay Shop coordinates
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: mapCenter,
                gestureHandling: 'greedy', // Enable pinch zoom on trackpad and scroll zoom with mouse
                scrollwheel: true, // Enable mouse wheel zoom
                zoomControl: true, // Show zoom controls
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                },
                fullscreenControl: true, // Enable fullscreen control
                mapTypeControl: true, // Enable map type controls (satellite/roadmap)
                mapTypeControlOptions: {
                    position: google.maps.ControlPosition.TOP_RIGHT,
                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR
                },
                styles: [
                    // Dark theme for the map
                    { elementType: 'geometry', stylers: [{ color: '#1a1f2e' }] },
                    { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1f2e' }] },
                    { elementType: 'labels.text.fill', stylers: [{ color: '#e2e8f0' }] },
                    { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2a3441' }] },
                    { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0f1419' }] }
                ]
            });

            // Add zoom listener for automatic satellite switching
            map.addListener('zoom_changed', () => {
                const currentZoom = map.getZoom();
                const highZoomThreshold = 19; // Approximately 7 clicks from initial zoom level 12

                if (currentZoom >= highZoomThreshold && map.getMapTypeId() !== google.maps.MapTypeId.SATELLITE) {
                    map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
                } else if (currentZoom < highZoomThreshold && map.getMapTypeId() !== google.maps.MapTypeId.ROADMAP) {
                    map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
                }
            });

            // Add click listener to map for pin dropping
            map.addListener('click', (event) => {
                const lat = event.latLng.lat();
                const lng = event.latLng.lng();

                // Update the form coordinates
                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lng.toFixed(6);

                // Place or move marker
                if (marker) {
                    marker.setPosition(event.latLng);
                } else {
                    marker = new google.maps.Marker({
                        position: event.latLng,
                        map: map,
                        title: 'Selected Location',
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#10b981"/>
                                    <circle cx="12" cy="9" r="2.5" fill="white"/>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(32, 32),
                            anchor: new google.maps.Point(16, 32)
                        }
                    });
                }

                console.log(`📍 Pin dropped at: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            });

            // Initialize autocomplete
            const addressInput = document.getElementById('address');
            if (addressInput) {
                // Create autocomplete instance for both addresses AND businesses in NW Arkansas
                autocomplete = new google.maps.places.Autocomplete(addressInput, {
                    types: ['establishment', 'geocode'], // Include businesses and addresses
                    componentRestrictions: {
                        country: 'us'
                    },
                    bounds: new google.maps.LatLngBounds(
                        new google.maps.LatLng(35.8, -94.8), // Southwest bound (covers Fayetteville area)
                        new google.maps.LatLng(36.5, -93.8)  // Northeast bound (covers Rogers/Bentonville)
                    ),
                    strictBounds: false, // Allow results outside bounds but prefer NW Arkansas
                    fields: ['name', 'formatted_address', 'geometry', 'place_id', 'types'] // Get business name
                });

                // When user selects a place, zoom map and auto-fill business names
                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();

                    if (place.geometry && place.geometry.location) {
                        const lat = place.geometry.location.lat();
                        const lng = place.geometry.location.lng();

                        // Update map view (zoom to parcel level + satellite view)
                        const location = { lat, lng };
                        map.setCenter(location);
                        map.setZoom(20); // Maximum zoom for parcel-level detail
                        map.setMapTypeId(google.maps.MapTypeId.SATELLITE); // Switch to satellite view

                        // Auto-fill business name if this is an establishment
                        const clientNameInput = document.getElementById('clientName');
                        if (place.name && place.types && place.types.includes('establishment')) {
                            // This is a business - auto-fill the location name with business name
                            clientNameInput.value = place.name;
                            console.log(`🏢 Auto-filled business name: ${place.name}`);
                        } else if (place.formatted_address && !clientNameInput.value.trim()) {
                            // This is just an address and no name is set - suggest using address
                            clientNameInput.placeholder = `Location at ${place.formatted_address.split(',')[0]}`;
                        }

                        // Clear any existing marker - user needs to click to place pin
                        if (marker) {
                            marker.setMap(null);
                            marker = null;
                        }

                        // Clear coordinates - user must click map to set them
                        document.getElementById('latitude').value = '';
                        document.getElementById('longitude').value = '';

                        console.log(`🔍 Map zoomed to: ${place.formatted_address}`);
                    }
                });

                // Add input listener for real-time search suggestions (duplicate check moved to form submission)
                let searchTimeout;
                addressInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    const query = addressInput.value.trim();

                    if (query.length > 3) {
                        searchTimeout = setTimeout(() => {
                            // Use geocoding service for broader search
                            const geocoder = new google.maps.Geocoder();
                            geocoder.geocode({
                                address: query,
                                bounds: new google.maps.LatLngBounds(
                                    new google.maps.LatLng(35.8, -94.8),
                                    new google.maps.LatLng(36.5, -93.8)
                                ),
                                region: 'us'
                            }, (results, status) => {
                                if (status === 'OK' && results[0]) {
                                    const location = results[0].geometry.location;
                                    map.setCenter(location);
                                    map.setZoom(20); // Maximum zoom for parcel-level detail
                                    map.setMapTypeId(google.maps.MapTypeId.SATELLITE); // Switch to satellite view
                                    console.log(`🛰️ Auto-zoomed to satellite parcel view: ${query}`);
                                }
                            });
                        }, 500); // Debounce for 500ms
                    }
                });
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadClients();

            // Initialize autocomplete if Google Maps is already loaded
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                initAutocomplete();
            }
        });
    </script>
</body>
</html>